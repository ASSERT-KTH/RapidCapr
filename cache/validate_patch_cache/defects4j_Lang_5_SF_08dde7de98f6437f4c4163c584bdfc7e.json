{
    "patch": "public static Locale toLocale(final String str) {\n    if (str == null) {\n        return null;\n    }\n    final int len = str.length();\n    if (len < 2) {\n        throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n    }\n    \n    int index1 = str.indexOf('_');\n    if (index1 < 0) {\n        if (len == 2 || len == 5) {\n            return new Locale(str);\n        } else if (len == 4) {\n            final char ch2 = str.charAt(2);\n            final char ch3 = str.charAt(3);\n            if (Character.isUpperCase(ch2) && Character.isUpperCase(ch3)) {\n                return new Locale(str.substring(0, 2), str.substring(2));\n            } else {\n                throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n            }\n        } else {\n            throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n        }\n    }\n    \n    int index2 = str.indexOf('_', index1 + 1);\n    if (index2 == -1) {\n        if (len != index1 + 3) {\n            throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n        }\n        final char ch0 = str.charAt(0);\n        final char ch1 = str.charAt(1);\n        final char ch3 = str.charAt(index1 + 1);\n        final char ch4 = str.charAt(index1 + 2);\n        if (Character.isUpperCase(ch3) && Character.isUpperCase(ch4)) {\n            return new Locale(str.substring(0, 2), \"\", str.substring(3));\n        } else if (Character.isLowerCase(ch0) && Character.isLowerCase(ch1)\n                && (Character.isUpperCase(ch3) || ch3 == '_')\n                && (Character.isUpperCase(ch4) || ch4 == '_')) {\n            return new Locale(str.substring(0, 2), str.substring(3));\n        } else {\n            throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n        }\n    }\n    \n    int index3 = str.indexOf('_', index2 + 1);\n    if (index3 == -1) {\n        final char ch0 = str.charAt(0);\n        final char ch1 = str.charAt(1);\n        final char ch3 = str.charAt(index1 + 1);\n        final char ch4 = str.charAt(index1 + 2);\n        final char ch6 = str.charAt(index2 + 1);\n        final char ch7 = str.charAt(index2 + 2);\n        if (index1 == 2 && Character.isUpperCase(ch3) && Character.isUpperCase(ch4)\n                && (Character.isUpperCase(ch6) || ch6 == '_')\n                && (Character.isUpperCase(ch7) || ch7 == '_')) {\n            return new Locale(str.substring(0, 2), \"\", str.substring(3));\n        } else if (Character.isLowerCase(ch0) && Character.isLowerCase(ch1)\n                && ((index1 == 2 && (Character.isUpperCase(ch3) || ch3 == '_')\n                        && (Character.isUpperCase(ch4) || ch4 == '_'))\n                        || (index1 == 3 && Character.isUpperCase(ch3)\n                                && Character.isUpperCase(str.charAt(index1 + 2)))\n                        || (index1 == 4 && Character.isUpperCase(ch3))\n                        || (index1 == len - 3))) {\n            return new Locale(str.substring(0, 2), str.substring(3, index1), str.substring(index1 + 1));\n        } else {\n            throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n        }\n    }\n    \n    final char ch0 = str.charAt(0);\n    final char ch1 = str.charAt(1);\n    final char ch3 = str.charAt(index1 + 1);\n    final char ch4 = str.charAt(index1 + 2);\n    final char ch6 = str.charAt(index2 + 1);\n    final char ch7 = str.charAt(index2 + 2);\n    if (Character.isLowerCase(ch0) && Character.isLowerCase(ch1)\n            && ((index1 == 2 && (Character.isUpperCase(ch3) || ch3 == '_')\n                    && (Character.isUpperCase(ch4) || ch4 == '_'))\n                    || (index1 == 3 && Character.isUpperCase(ch3)\n                            && Character.isUpperCase(str.charAt(index1 + 2)))\n                    || (index1 == 4 && Character.isUpperCase(ch3))\n                    || (index1 == len - 3))\n            && ((index2 - index1) == 3\n                    && (Character.isUpperCase(ch6) || ch6 == '_')\n                    && (Character.isUpperCase(ch7) || ch7 == '_'))) {\n        return new Locale(str.substring(0, 2), str.substring(3, index1), str.substring(index1 + 1, index2));\n    } else {\n        throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n    }\n}",
    "patch_diff": "diff --git a/src/main/java/org/apache/commons/lang3/LocaleUtils.java b/src/main/java/org/apache/commons/lang3/LocaleUtils.java\nindex bc779d04..7a6c1a21 100644\n--- a/src/main/java/org/apache/commons/lang3/LocaleUtils.java\n+++ b/src/main/java/org/apache/commons/lang3/LocaleUtils.java\n@@ -85,47 +85,98 @@ public class LocaleUtils {\n      * @return a Locale, null if null input\n      * @throws IllegalArgumentException if the string is an invalid format\n      */\n-    public static Locale toLocale(final String str) {\n-        if (str == null) {\n-            return null;\n+public static Locale toLocale(final String str) {\n+    if (str == null) {\n+        return null;\n+    }\n+    final int len = str.length();\n+    if (len < 2) {\n+        throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n+    }\n+    \n+    int index1 = str.indexOf('_');\n+    if (index1 < 0) {\n+        if (len == 2 || len == 5) {\n+            return new Locale(str);\n+        } else if (len == 4) {\n+            final char ch2 = str.charAt(2);\n+            final char ch3 = str.charAt(3);\n+            if (Character.isUpperCase(ch2) && Character.isUpperCase(ch3)) {\n+                return new Locale(str.substring(0, 2), str.substring(2));\n+            } else {\n+                throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n+            }\n+        } else {\n+            throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n         }\n-        final int len = str.length();\n-        if (len < 2) {\n+    }\n+    \n+    int index2 = str.indexOf('_', index1 + 1);\n+    if (index2 == -1) {\n+        if (len != index1 + 3) {\n             throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n         }\n         final char ch0 = str.charAt(0);\n-            final char ch1 = str.charAt(1);\n-            if (!Character.isLowerCase(ch0) || !Character.isLowerCase(ch1)) {\n-                throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n-            }\n-            if (len == 2) {\n-                return new Locale(str);\n-            }\n-            if (len < 5) {\n-                throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n-            }\n-            if (str.charAt(2) != '_') {\n-                throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n-            }\n-            final char ch3 = str.charAt(3);\n-            if (ch3 == '_') {\n-                return new Locale(str.substring(0, 2), \"\", str.substring(4));\n-            }\n-            final char ch4 = str.charAt(4);\n-            if (!Character.isUpperCase(ch3) || !Character.isUpperCase(ch4)) {\n-                throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n-            }\n-            if (len == 5) {\n-                return new Locale(str.substring(0, 2), str.substring(3, 5));\n-            }\n-            if (len < 7) {\n-                throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n-            }\n-            if (str.charAt(5) != '_') {\n-                throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n-            }\n-            return new Locale(str.substring(0, 2), str.substring(3, 5), str.substring(6));\n+        final char ch1 = str.charAt(1);\n+        final char ch3 = str.charAt(index1 + 1);\n+        final char ch4 = str.charAt(index1 + 2);\n+        if (Character.isUpperCase(ch3) && Character.isUpperCase(ch4)) {\n+            return new Locale(str.substring(0, 2), \"\", str.substring(3));\n+        } else if (Character.isLowerCase(ch0) && Character.isLowerCase(ch1)\n+                && (Character.isUpperCase(ch3) || ch3 == '_')\n+                && (Character.isUpperCase(ch4) || ch4 == '_')) {\n+            return new Locale(str.substring(0, 2), str.substring(3));\n+        } else {\n+            throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n+        }\n     }\n+    \n+    int index3 = str.indexOf('_', index2 + 1);\n+    if (index3 == -1) {\n+        final char ch0 = str.charAt(0);\n+        final char ch1 = str.charAt(1);\n+        final char ch3 = str.charAt(index1 + 1);\n+        final char ch4 = str.charAt(index1 + 2);\n+        final char ch6 = str.charAt(index2 + 1);\n+        final char ch7 = str.charAt(index2 + 2);\n+        if (index1 == 2 && Character.isUpperCase(ch3) && Character.isUpperCase(ch4)\n+                && (Character.isUpperCase(ch6) || ch6 == '_')\n+                && (Character.isUpperCase(ch7) || ch7 == '_')) {\n+            return new Locale(str.substring(0, 2), \"\", str.substring(3));\n+        } else if (Character.isLowerCase(ch0) && Character.isLowerCase(ch1)\n+                && ((index1 == 2 && (Character.isUpperCase(ch3) || ch3 == '_')\n+                        && (Character.isUpperCase(ch4) || ch4 == '_'))\n+                        || (index1 == 3 && Character.isUpperCase(ch3)\n+                                && Character.isUpperCase(str.charAt(index1 + 2)))\n+                        || (index1 == 4 && Character.isUpperCase(ch3))\n+                        || (index1 == len - 3))) {\n+            return new Locale(str.substring(0, 2), str.substring(3, index1), str.substring(index1 + 1));\n+        } else {\n+            throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n+        }\n+    }\n+    \n+    final char ch0 = str.charAt(0);\n+    final char ch1 = str.charAt(1);\n+    final char ch3 = str.charAt(index1 + 1);\n+    final char ch4 = str.charAt(index1 + 2);\n+    final char ch6 = str.charAt(index2 + 1);\n+    final char ch7 = str.charAt(index2 + 2);\n+    if (Character.isLowerCase(ch0) && Character.isLowerCase(ch1)\n+            && ((index1 == 2 && (Character.isUpperCase(ch3) || ch3 == '_')\n+                    && (Character.isUpperCase(ch4) || ch4 == '_'))\n+                    || (index1 == 3 && Character.isUpperCase(ch3)\n+                            && Character.isUpperCase(str.charAt(index1 + 2)))\n+                    || (index1 == 4 && Character.isUpperCase(ch3))\n+                    || (index1 == len - 3))\n+            && ((index2 - index1) == 3\n+                    && (Character.isUpperCase(ch6) || ch6 == '_')\n+                    && (Character.isUpperCase(ch7) || ch7 == '_'))) {\n+        return new Locale(str.substring(0, 2), str.substring(3, index1), str.substring(index1 + 1, index2));\n+    } else {\n+        throw new IllegalArgumentException(\"Invalid locale format: \" + str);\n+    }\n+}\n \n     //-----------------------------------------------------------------------\n     /**",
    "result_reason": "java.lang.StringIndexOutOfBoundsException: String index out of range: 5",
    "test_result": "FAIL"
}